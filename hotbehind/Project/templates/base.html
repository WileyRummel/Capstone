<!-- templates/base.html -->
{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://necolas.github.io/normalize.css/8.0.1/normalize.css"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/base.css' %}" />

    <title>{% block title %}Feed Feed{% endblock %}</title>
  </head>
  <body>
    <!--Make a main to hold everything or use multiple vue apps-->
    {% csrf_token %}

    <main>
      {% block content %} {% endblock %}
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue"></script>
    <script>
      Vue.component("search-bar", {
        delimiters: ["[[", "]]"],

        data: function() {
          return {
            selectedFilter: "",
            search: "",
            results: []
          };
        },

        props: [],

        template: 
        ` <div id="searcharea">
        <form id="searchform" class="form-horizontal">
          <input
            field="text"
            placeholder="Search..."
            id="searchfield"
            v-model.lazy="search"
          />
          <select class="topmenu" id="drop" v-model="selectedFilter">
            <option disable value="">Search By:</option>
            <option @change="($event)">Restaurants</option>
            <option @change="($event)">Reviews</option>
            <!-- <option @change="($event)">Cuisines</option>
        <option @change="($event)">Settings</option> -->
          </select>
          <button
            class="topmenu"
            id="search"
            @click.prevent="getFilter($event)"
          >
            Search
          </button>
        </form>
      </div>`,

        methods: {
          getFilter() {
            if (this.selectedFilter == "Restaurants") {
              axios({
                method: "get",
                url: `/api/restaurants/?search=${this.search}`
              })
                .then(res => this.$emit("givesearch", res.data))
                .catch(e => console.log(e));
            } else if (this.selectedFilter == "Reviews") {
              axios({
                method: "get",
                url: `/api/reviews/?search=${this.search}`
              })
                .then(res => this.$emit("givesearch", res.data))
                .catch(e => console.log(e));
            }
          }
        }
      });

      Vue.component("restaurant-detail", {
        delimiters: ["[[", "]]"],

        data: function() {
          return {
            reviewForm: false,
            restaurant: this.restObj.name
          };
        },

        props: ["rest-obj", "reviewForm"],

        template: `
          <div class="restaurantcontainer">
            <img class="restaurantdetails photo" :src='restObj.photo'/>
            <h3 class="restaurantdetails restname"> [[restObj.name]] </h3>
            <p class="restaurantdetails hours"> [[restObj.hours]] </p>
            <p class="restaurantdetails location"> [[restObj.location]] </p>
            <p class="restaurantdetails website"><a :href='restObj.website'> site link</a> <button @click.prevent="sendevent()" id="reviewbtn" class="topmenu"> Review [[restObj.name]]  </button> </p>
            <p class="restaurauntdetails settings" :restObj="settingstring" v-if="restObj.setting_info">Great for: [[restObj.setting_info]] </p>
            <p class="restaurantdetails settings" v-else>No setting information currently available. </p>
            <p class="restaurantdetails cuisines" :restObj="cuisinestring" >Cuisines: [[restObj.cuisine_info]] </p>
            <review-form v-if="reviewForm" :restaurant="restObj"></review-form>
          </div>

          `,
        computed: {
          //these computed properties are used during restaurant detail rendering.  They manipulate the array of objects for settings and cuisines and return a human readable string for better presentation and legibility.
          settingstring: function(x) {
            let stringed = ""; //initializing a dummy string to use in data manipulation
            x.restObj.setting_info.forEach(element => {
              stringed += element.options + ", "; //adding the value of each option to the string
            });

            let strlen = stringed.length;

            stringed = stringed.slice(0, strlen - 2); //removing the last two characters based on the length of the string

            x.restObj.setting_info = stringed; //returing the proper variable, but redifined as the string version of the list
          },
          cuisinestring: function(x) {
            let stringed = "";
            x.restObj.cuisine_info.forEach(element => {
              stringed += element.options + ", ";
            });

            let strlen = stringed.length;

            stringed = stringed.slice(0, strlen - 2);

            x.restObj.cuisine_info = stringed;
          }
        },
        methods: {
          sendevent() {
            // this.$emit('review', this.restObj)
            (this.reviewForm = true), console.log(this.restObj);
          }
        }
      });
      Vue.component("review-detail", {
        delimiters: ["[[", "]]"],

        props: ["rev-obj"], //this will be revObj in the template

        template: `
        <div class="reviewcontainer">
          <h3 class="reviewdetail restaurantname"> [[revObj.restaurant_info.name]] </h3>
          <p class="reviewdetail userinfo"> <b>[[revObj.author_info.username]]</b> : [[revObj.author_info.role]]</p>
          <p class="reviewdetail revdate"> [[revObj.created]] </p>
          <p class="reviewdetail revrating"><b> [[revObj.rating]] Stars </b></p>
          <p class="reviewdetail revbody"> [[revObj.body]] </p>
        </div>
        `
      });

      Vue.component("review-form", {
        delimiters: ["[[", "]]"],

        data: function() {
          return {
            csrf_token: "",
            currentuser: "",
            reviewbody: "",
            reviewrating: ""
          };
        },

        props: ["author", "restaurant"], //this will likely need a restaurant object so that each button will know that it is a review for that specific restaurant

        template: `
        <div class="makereview" >
          <form> 
            <p> [[currentuser.username]]  </p>
            <p> [[restaurant.name]] </p>
            <input type="textarea" placeholder="Write your review here." class="reviewbody" v-model="reviewbody">
            <select name="rating" v-model="reviewrating">
              <option value="1">Poor</option>
              <option value="2">Decent </option>
              <option value="3">Good </option>
              <option value="4">Great </option>
              <option value="5">Excellent</option>
            </select>
            <input type="submit" value="submit" @click.prevent="postreview()" id="postreview">
          </form>
        </div>
        `,

        methods: {
          postreview() {
            axios({
              method: "post",
              url: "/api/reviews/",
              data: {
                // csrf_token: this.csrf_token,
                author: this.currentuser.id,
                restaurant: this.restaurant.id,
                body: this.reviewbody,
                rating: this.reviewrating
              },
              headers: {
                "X-CSRFToken": this.csrf_token
              }
            }).then(x => {
              console.log(x);
              if (x.status == "201") {
                alert("Review Successfully posted");
              } else {
                alert(
                  "Oops... Something went wrong.  Make sure you are logged in on an approved account."
                );
              }
            });
          }
        },

        mounted: function() {
          axios({
            method: "get",
            url: "/api/currentuser"
          })
            .then(res =>
              console.log(res.data.username, (this.currentuser = res.data))
            )
            .catch(error => console.log(error));
          this.csrf_token = document.querySelector(
            "input[name=csrfmiddlewaretoken]"
          ).value;
          console.log(this.csrf_token);
        }
      });

      Vue.component("restaurant-create", {
        delimiters: ["[[", "]]"],

        data: function() {
          return {
            // restaurantform: false,
            csrf_token: "",
            name: "",
            location: "",
            hours: "",
            website: "",
            restaurantsetting: [],
            restaurantcuisine: [],
          };
        },

        props: [],

        template: `
        <div class="createcontainer">
          <form class="restaurantform">
            <input type="text" placeholder="restaurant name" v-model="name">
            <input type="text" placeholder="hours" v-model="hours">
            <input type="text" placeholder="location" v-model="location">
            <p>Cuisines:</p>
            <select v-model="restaurantcuisine">
              <option v-for="cuisine in restaurantcuisine" :value="cuisine.element.id">
                [[cuisine.element.options]]
              </option> 
            </select>
            <p> Great for this:</p>
            <select v-model="restaurantsetting">
              <option v-for="setting in restaurantsetting" :value="setting.element.id" >
                [[setting.element.options]]
              </option>
            </select>
            <input type="url" placeholder="website" v-model="website">
            <input type="submit" value="sumbit" @click.prevent="postrestaurant()">
          </form>
        </div>
        `,
        // for cuisines and settings build a select & options. Look in vue js v-for selector, form input bindings.  The option for loop as shown above likely won't work, but its the general idea
        // mounted: function() {
        //   this.csrf_token = document.querySelector(
        //     "input[name=csrfmiddlewaretoken]"
        //   ).value;
        // },
        methods: {
          //method to make a post request to submit a new restaurant to the api.
          postrestaurant() {
            console.log("called the function"),
            axios({
              method: "post",
              url: "/api/restaurants/",
              data: {
                name: this.name,
                location: this.location,
                hours: this.hours,
                website: this.website,
                photo: null,
                cuisines: [this.restaurantcuisine],
                settings: [this.restaurantsetting], //will this work without cuisine_info and settings_info?  Seems weird.
              },
              headers: {
                "X-CSRFToken": this.csrf_token
              }
            }).then(res => {
              if (res.status == "201") { 
                alert("Restaurant Submission Successful! Thank You for helping the community with your submission. ")}
              else {
                alert("Sorry! Your restaurant submission failed to complete.  Check that you are logged into an approved account and try again.")
              }});
          }
        },
        mounted: function() {
          axios({
            method: "get",
            url: "http://localhost:8000/api/cuisines/"
          }).then(response => {
            response.data.forEach(element => {
              this.restaurantcuisine.push({element});
            }),console.log(this.restaurantcuisine);
          });
          axios({
            method: "get",
            url: "http://localhost:8000/api/settings/"
          }).then(response => {
            response.data.forEach(element => {
              this.restaurantsetting.push({element});
            }),console.log(this.restaurantsetting);
          });
          this.csrf_token = document.querySelector(
            "input[name=csrfmiddlewaretoken]"
          ).value;
        }
      });
    </script>
    {% block script %} {% endblock %}
  </body>
</html>
